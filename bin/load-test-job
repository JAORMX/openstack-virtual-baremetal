#!/bin/bash

# Edit these to match your environment
AUTH_URL=http://11.1.1.78:5000/v2.0
USER=admin
PASSWORD=password
TENANT=admin
BMC_IMAGE=centos7.1-base
KEY_NAME=bnemec
UNDERCLOUD_IMAGE=centos7.1-base
UNDERCLOUD_FLAVOR=m1.large
BAREMETAL_FLAVOR=baremetal-6

set -ex

date

BIN_DIR=$(cd $(dirname $0); pwd -P)
MY_ID=$1

BMC_PREFIX=bmc-$MY_ID
BAREMETAL_PREFIX=baremetal-$MY_ID
UNDERCLOUD_NAME=undercloud-$MY_ID
PUBLIC_NET=public-$MY_ID
PROVISION_NET=${BAREMETAL_PREFIX}_0 #provision-$MY_ID

TEMPDIR=$(mktemp -d)
echo "Working in $TEMPDIR"
cd $TEMPDIR

cp -r $BIN_DIR/../templates .
cp templates/env.yaml.example ./env.yaml
sed -i "s|os_auth_url: .*|os_auth_url: $AUTH_URL|" env.yaml
sed -i "s|os_user: .*|os_user: $USER|" env.yaml
sed -i "s|os_password: .*|os_password: $PASSWORD|" env.yaml
sed -i "s|os_tenant: .*|os_tenant: $TENANT|" env.yaml
sed -i "s/bmc_image: .*/bmc_image: $BMC_IMAGE/" env.yaml
sed -i "s/key_name: .*/key_name: $KEY_NAME/" env.yaml
sed -i "s/bmc_prefix: .*/bmc_prefix: $BMC_PREFIX/" env.yaml
sed -i "s/baremetal_prefix: .*/baremetal_prefix: $BAREMETAL_PREFIX/" env.yaml
sed -i "s/baremetal_flavor: .*/baremetal_flavor: $BAREMETAL_FLAVOR/" env.yaml
sed -i "s/undercloud_name: .*/undercloud_name: $UNDERCLOUD_NAME/" env.yaml
sed -i "s/undercloud_image: .*/undercloud_image: $UNDERCLOUD_IMAGE/" env.yaml
sed -i "s/undercloud_flavor: .*/undercloud_flavor: $UNDERCLOUD_FLAVOR/" env.yaml
sed -i "s/public_net: .*/public_net: $PUBLIC_NET/" env.yaml
sed -i "s/provision_net: .*/provision_net: $PROVISION_NET/" env.yaml
echo 'resource_registry:' >> env.yaml
echo '  OS::OVB::UndercloudFloating: templates/undercloud-floating.yaml' >> env.yaml

cp -r $BIN_DIR ./bin
$BIN_DIR/deploy-quintupleo create quintupleo-$MY_ID
sleep 60
UNDERCLOUD_IP=$(heat output-show quintupleo-$MY_ID undercloud_host_floating_ip | sed -e 's/"//g')
#bin/build-nodes-json --env env.yaml #--bmc_prefix $BMC_PREFIX --baremetal_prefix $BAREMETAL_PREFIX --provision_net $PROVISION_NET_NAME
bin/build-nodes-json --bmc_prefix $BMC_PREFIX --baremetal_prefix $BAREMETAL_PREFIX --provision_net $PROVISION_NET
SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
scp $SSH_OPTS bin/ovb-instack centos@$UNDERCLOUD_IP:/tmp
scp $SSH_OPTS nodes.json centos@$UNDERCLOUD_IP:~/instackenv.json
ssh -t -t $SSH_OPTS centos@$UNDERCLOUD_IP /tmp/ovb-instack
heat stack-delete quintupleo-$MY_ID

date
echo 'Finished'
rm -rf $TEMPDIR
